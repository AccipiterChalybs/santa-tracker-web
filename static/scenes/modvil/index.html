<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lobster|Google+Sans:400,500,700" />
  <link rel="stylesheet" href="index.css" />

  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
</head>
<body>

<script type="module">
import api from '../../src/scene/api.js';
import '../../src/polyfill/css.js';  // FIXME: should be included centrally?
import '../../src/elements/santa-card.js';
import '../../src/elements/santa-weather.js';
import * as helpers from './helpers.js';
import {prepareAnimation} from '../../src/deps/lottie.js';


api.preload.sounds('village_load_sounds');
api.preload.sounds('elfmaker_load_sounds');  // TODO: for generic_button_click
api.config({
  scroll: true,
  sound: ['music_start_village', 'village_start'],
});

async function prepare() {
  const modules = ['transport', 'sciencelab'];
  const scenes = ['elfmaker', 'penguindash', 'museum', 'santaselfie', 'snowball', 'boatload'];
  const main = document.querySelector('main');

  const all = modules.map(async (name) => {
    const d = document.createElement('div');
    d.className = 'module';
    d.setAttribute('id', `module--${name}`);
    main.append(d);
    d.style.backgroundImage = `url(img/modules/${name}.svg)`;

    const cardsEl = document.createElement('div');
    cardsEl.className = 'cards';
    d.append(cardsEl);

    for (let i = 0; i < 3; ++i) {
      const next = scenes.pop();
      if (!next) {
        continue;
      }
      const card = document.createElement('santa-card');
      card.setAttribute('scene', next);
      cardsEl.append(card);

      if (Math.random() < 0.2) {
        card.setAttribute('locked', ~~(Math.random() * 23) + 1);
      }
    }

    const animationPromise = prepareAnimation(`img/modules/${name}.json`, {
      rendererSettings: {
        className: 'animation__svg',
        preserveAspectRatio: 'xMaxYMax meet',
      },
      clearDefs: true,
    }).then((anim) => {
      d.appendChild(anim.renderer.svgElement);
      return anim;
    });

    const anim = await animationPromise;
    const frames = anim.getDuration(true);

    return () => {
      const se = document.scrollingElement;
      const topScroll = se.scrollTop;

      // The start of this element is effectively min window height (can't scroll above this point).
      const effectiveStart = Math.max(0, d.offsetTop - window.innerHeight);
      const effectiveEnd = Math.min(se.offsetHeight - window.innerHeight, d.offsetTop + d.offsetHeight);

      const ratio = (topScroll - effectiveStart) / (effectiveEnd - effectiveStart);
      let outputRatio;

      if (ratio <= 0.0) {
        outputRatio = 0.0;
      } else if (ratio >= 1.0) {
        outputRatio = 1.0;
      } else {
        // This creates more of a cubic-bezier style transform (although it's quite subtle).
        outputRatio = (Math.sin((ratio - 0.5) * Math.PI) + 1) * 0.5;
        console.info(name, ratio, outputRatio);
      }

      const frame = Math.min(frames, Math.max(0.0, frames * outputRatio));
      anim.goToAndStop(frame, true);
    };
  });
  const done = await Promise.all(all);

  // TODO(samthor): This sets the position based on the overall page ratio, not the ratio within
  // each animation. This obviously needs fixing.

  helpers.installAdjustHandler(() => {
    if (window.innerWidth < 768) {
      return;
    }
    done.forEach((fn) => fn());
  });
}

api.preload.wait(prepare());

const playButton = document.getElementById('play');

playButton.addEventListener('click', (ev) => {
  playButton.classList.add('active');
  api.go('codelab');
});
playButton.addEventListener('mousedown', () => {
  api.play('generic_button_click');
});
playButton.addEventListener('touchdown', () => {
  api.play('generic_button_click');
});



api.ready(async () => {

});

</script>

<div id="top">
  <santa-weather></santa-weather>
  <header>
    <div id="ornament"></div>
    <h1 msgid="santatracker"></h1>
    <button id="play"><span msgid="play"></span></button>
  </header>
  <div id="newtoday">
    <span msgid="newtoday"></span>
    <santa-card scene="elfmaker"></santa-card>
  </div>
</div>

<div id="modules">
  <div class="sidebar left"></div>
  <main></main>
  <div class="sidebar right"></div>
</div>

</div>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lobster|Google+Sans:400,500,700" />
  <link rel="stylesheet" href="index.css" />

  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../node_modules/lottie-web/build/player/lottie_light.min.js"></script>
</head>
<body>

<script type="module">
import api from '../../src/scene/api.js';
import '../../src/polyfill/css.js';  // FIXME: should be included centrally?
import '../../src/elements/santa-card.js';
import * as helpers from './helpers.js';


api.preload.sounds('village_load_sounds');
api.preload.sounds('elfmaker_load_sounds');  // TODO: for generic_button_click
api.config({
  sound: ['music_start_village', 'village_start'],
});

async function prepare() {
  const modules = ['transport', 'sciencelab'];
  const scenes = ['elfmaker', 'penguindash', 'comroom', 'santaselfie', 'snowball', 'boatload'];
  const main = document.querySelector('main');

  const all = modules.map(async (name) => {
    const d = document.createElement('div');
    d.className = 'module';
    d.setAttribute('id', `module--${name}`);
    main.append(d);
    d.style.backgroundImage = `url(img/modules/${name}.svg)`;

    const cardsEl = document.createElement('div');
    cardsEl.className = 'cards';
    d.append(cardsEl);

    for (let i = 0; i < 3; ++i) {
      const next = scenes.pop();
      if (!next) {
        continue;
      }
      const card = document.createElement('santa-card');
      card.setAttribute('scene', next);
      cardsEl.append(card);

      if (Math.random() < 0.5) {
        card.setAttribute('locked', ~~(Math.random() * 23) + 1);
      }
    }

    const animationPromise = helpers.initAnimation(d, name, 'xMaxYMax meet').then((anim) => {
      const svg = anim.renderer.svgElement;

      // clips are added by the Lottie file author. Remove.
      const defs = svg.querySelector('defs');
      defs && defs.remove();
      return anim;
    });

    const anim = await animationPromise;
    const frames = anim.getDuration(true);
    console.info(name, 'got frames', frames);

    return (ratio) => {
      const frame = Math.max(0.0, frames * ratio);
      anim.goToAndStop(frame, true);
    };
  });
  const done = await Promise.all(all);

  // TODO(samthor): This sets the position based on the overall page ratio, not the ratio within
  // each animation. This obviously needs fixing.

  helpers.installAdjustHandler(() => {
    if (window.innerWidth < 768) {
      return;
    }

    const se = document.scrollingElement;
    const delta = (se.scrollHeight - window.innerHeight);
    const ratio = delta > 0 ? se.scrollTop / delta : 0;
    console.info('ratio', ratio);

    done.forEach((fn) => fn(ratio));
  });
}

api.preload.wait(prepare());

const playButton = document.getElementById('play');

playButton.addEventListener('click', (ev) => {
  playButton.classList.add('active');
  api.go('codelab');
});
playButton.addEventListener('mousedown', () => {
  api.play('generic_button_click');
});
playButton.addEventListener('touchdown', () => {
  api.play('generic_button_click');
});



api.ready(async () => {

});

</script>

<div id="top">
  <header>
    <div id="ornament"></div>
    <h1>Santa Tracker</h1>
    <button id="play"><span msgid="play"></span></button>
  </header>
  <div id="newtoday">
    <span msgid="newtoday"></span>
    <santa-card scene="elfmaker"></santa-card>
  </div>
</div>

<div id="modules">
  <div class="sidebar left"></div>
  <main></main>
  <div class="sidebar right"></div>
</div>

</div>

</body>
</html>

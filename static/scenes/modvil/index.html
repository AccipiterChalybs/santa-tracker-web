<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Lobster" />
  <link rel="stylesheet" href="index.css" />

  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../third_party/lib/lottie/lottie.min.js"></script>
</head>
<body>

<script type="module">
import api from '../../src/scene/api.js';
import '../../src/polyfill/css.js';  // FIXME: should be included centrally?
import '../../src/elements/santa-card.js';

const growSvgBy = 5000;
const moduleHeight = 650;

const loadHtmlLike = async (src) => {
  const resp = await window.fetch(src);
  const raw = await resp.text();

  const holder = document.createElement('div');
  holder.innerHTML = raw;

  return holder.children[0];
};

function parseViewBox(svg) {
  const viewBox = svg.getAttribute('viewBox');
  const parts = viewBox.split(/\s+/g);
  const x = +parts[0] || 0;
  const y = +parts[1] || 0;
  const w = +parts[2] || 0;
  const h = +parts[3] || 0;
  return {x, y, w, h};
}

function adjustSvgSize(svg) {
  const v = parseViewBox(svg);
  const heightRatio = v.h / moduleHeight;

  v.x -= growSvgBy;
  v.w += growSvgBy * 2;
  svg.setAttribute('viewBox', `${v.x} ${v.y} ${v.w} ${v.h}`);
  svg.style.height = `${moduleHeight}px`;
  svg.style.top = '0px';
  svg.style.left = `calc(-${v.w / 2 / heightRatio}px + 50vw)`;

  // Lottie-imported elements set these, remove.
  svg.style.width = 'auto';
  svg.removeAttribute('width');
  svg.removeAttribute('height');
}

const initAnimation = (container, key, preserveAspectRatio) => {
  const p = new Promise((resolve, reject) => {
    const anim = lottie.loadAnimation({
      container,
      autoplay: false,
      renderer: 'svg',
      path: `img/modules/${key}.json`,
      rendererSettings: {
        className: 'animation__svg',
        preserveAspectRatio,
      },
    });
    anim.addEventListener('DOMLoaded', () => {
      resolve({
        svg: anim.renderer.svgElement,
        anim,
      });
    });
    anim.addEventListener('data_failed', reject);
  });
  api.preload.wait(p);
  return p;
};

function installAdjustHandler(handler) {
  let rAF = 0;
  const internalHandler = () => {
    rAF = 0;
    handler();
  };
  rAF = window.requestAnimationFrame(internalHandler);

  const eventHandler = () => {
    if (rAF === 0) {
      rAF = window.requestAnimationFrame(internalHandler);
    }
  };
  ['scroll', 'resize'].forEach((eventType) => {
    window.addEventListener(eventType, eventHandler, {passive: true});
  });
}


async function prepare() {
  const modules = ['sciencelab', 'transport'];
  const scenes = ['elfmaker', 'penguindash', 'santasearch', 'santaselfie', 'snowball', 'boatload'];

  const all = modules.map(async (name) => {
    const d = document.createElement('div');
    d.className = 'module';
    d.setAttribute('id', `module--${name}`);
    document.body.append(d);

    const cardsEl = document.createElement('div');
    cardsEl.className = 'cards';
    d.append(cardsEl);

    for (let i = 0; i < 3; ++i) {
      const next = scenes.pop();
      if (!next) {
        continue;
      }
      const card = document.createElement('santa-card');
      card.setAttribute('scene', next);
      cardsEl.append(card);

      if (Math.random() < 0.5) {
        card.setAttribute('locked', ~~(Math.random() * 23) + 1);
      }
    }

    const backgroundPromise = loadHtmlLike(`img/modules/${name}.svg`).then((svg) => {
      adjustSvgSize(svg);

      const img = document.createElement('img');
      img.src = `data:image/svg+xml;base64,${btoa(svg.outerHTML)}`;

      img.style.left = svg.style.left;
      img.style.height = svg.style.height;
      img.style.width = svg.style.width;

      d.append(img);
    });

    const animationPromise = initAnimation(d, name, 'xMaxYMax meet').then(({svg, anim}) => {
      adjustSvgSize(svg);

      // clips are added by the Lottie file author. Remove.
      const defs = svg.querySelector('defs');
      defs.remove();
      return anim;
    });

    await backgroundPromise;
    const anim = await animationPromise;
    const frames = anim.getDuration(true);
    console.info('got frames', frames);

    return (ratio) => {
      const frame = Math.max(0.0, frames * ratio);
      anim.goToAndStop(frame, true);
    };
  });
  const done = await Promise.all(all);

  // TODO(samthor): This sets the position based on the overall page ratio, not the ratio within
  // each animation. This obviously needs fixing.

  installAdjustHandler(() => {
    const se = document.scrollingElement;
    const delta = (se.scrollHeight - window.innerHeight);
    const ratio = delta > 0 ? se.scrollTop / delta : 0;
    console.info('ratio', ratio);

    done.forEach((fn) => fn(ratio));
  });
}

api.preload.wait(prepare());

</script>

<div id="top">
  <h1>Santa Tracker</h1>
  <span>Placeholder</span>
</div>

</body>
</html>

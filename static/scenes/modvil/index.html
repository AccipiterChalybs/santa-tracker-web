<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lobster|Google+Sans:400,500,700" />
  <link rel="stylesheet" href="index.css" />

  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
</head>
<body>

<script type="module">
import api from '../../src/scene/api.js';
import '../../src/polyfill/css.js';  // FIXME: should be included centrally?
import '../../src/elements/santa-card.js';
import '../../src/elements/santa-weather.js';
import * as helpers from './helpers.js';
import {loadAnimation} from '../../src/deps/lottie.js';
import {animationSoundTriggers} from './animationSoundTriggers.js'
import './elements/modvil-module.js';
import {_msg} from '../../src/magic.js';


api.preload.sounds('village_load_sounds');
api.preload.sounds('generic_load_sounds');
api.config({
  scroll: true,
  subscribe: true,  // subscribe to remote config
  sound: ['music_start_village', 'village_start'],
});

const allCards = Array.from(document.querySelectorAll('santa-card'));

api.addEventListener('data', (ev) => {
  // TODO: use this state to control card locked/unlocked
  console.info('got snapshot', ev.detail);

  const {routes} = ev.detail;

  allCards.forEach((card) => {
    const detail = routes[card.id] || {video: false, locked: undefined};
    card.locked = detail.locked;
  });

});


/**
 * Finds the ratio of scrolling that this element should display at.
 */
function ratioForElement(el) {
  const se = document.scrollingElement;
  const topScroll = se.scrollTop;

  // The start of this element is effectively min window height (can't scroll above this point).
  const effectiveStart = Math.max(0, el.offsetTop - window.innerHeight);
  const effectiveEnd = Math.min(se.offsetHeight - window.innerHeight, el.offsetTop + el.offsetHeight);

  const ratio = (topScroll - effectiveStart) / (effectiveEnd - effectiveStart);

  if (ratio <= 0.0) {
    return 0.0;
  } else if (ratio >= 1.0) {
    return 1.0;
  }
  // This creates more of a cubic-bezier style transform (although it's quite subtle).
  return (Math.sin((ratio - 0.5) * Math.PI) + 1) * 0.5;
}


/**
 * @param {string} id to play for
 * @param {?number} ratio to play at
 */
const updateModuleSoundRatio = (function() {
  const previous = {};

  return (id, ratio) => {
    api.play('village_scroll', id, ratio);

  // TODO(samthor): Should we prevent lots of repeat events here?
  // prevent sending lots of repeat events for [0,1]
  // Klang's config seems to do nothing in this case anyway; the speed would be Infinity

/*
    ratio = ratio || 0;

    if ((previous[id] || 0) === ratio) {
      return;  // already set
    }

    previous[id] = ratio;
    api.play('village_scroll', id, ratio);
*/
  };
}());



async function prepareModules() {
  const main = document.querySelector('main');
  const topModule = document.getElementById('top');
  const modules = Array.from(main.querySelectorAll('modvil-module'));

  helpers.installAdjustHandler(() => {
    let mode = '';
    if (window.innerWidth <= 414) {
      mode = 'mobile';
    } else if (window.innerWidth <= 768) {
      mode = 'small';
    }

    let visible = undefined;  // undefined=at top, true=visible, false=after visible

    const se = document.scrollingElement;
    const windowRangeLow = se.scrollTop;
    const windowRangeHigh = se.scrollTop + window.innerHeight;

    // Top isn't a module, but it has audio cues.
    const topRatio = ratioForElement(topModule);
    updateModuleSoundRatio('top', topRatio);

    modules.forEach((m) => {
      if (visible !== false) {
        if (m.offsetTop >= windowRangeHigh) {
          visible = false;
        }
      }
      if (visible === undefined) {
        if (m.offsetTop + m.offsetHeight >= windowRangeLow) {
          visible = true;
        }
      }

      // Configure the CE. Ratio of null hints that the scene is invisible.
      const ratio = visible ? ratioForElement(m) : null;
      m.ratio = ratio;
      m.mode = mode;
      m.load = visible || false;  // only display at all when visible

      // Configure ratio of sound.
      updateModuleSoundRatio(m.id, ratio);
    });
  });


  main.addEventListener('anim', (e) => {
    const scene = e.target.id;
    const {index, currentTime} = e.detail;
    checkAndPlaySound(scene, index, currentTime);
  });
}

function checkAndPlaySound(scene, index, time) {
  if (animationSoundTriggers[scene] && animationSoundTriggers[scene][index]) {
    const sounds = animationSoundTriggers[scene][index];

    for (let i = 0; i < sounds.length; i++) {
      if (time > sounds[i].time && time < (sounds[i].time + 5) && (performance.now() - sounds[i].played) > 1000) {
        api.play(sounds[i].sound, time);
        sounds[i].played = performance.now();
      }
    }
  }
}

api.preload.wait(prepareModules());

const playButton = document.getElementById('play');

playButton.addEventListener('click', (ev) => {
  playButton.classList.add('active');
  api.go('codelab');
});
playButton.addEventListener('mousedown', () => {
  api.play('generic_button_click');
});
playButton.addEventListener('mouseenter', () => {
  api.play('generic_button_over');
});
playButton.addEventListener('touchdown', () => {
  api.play('generic_button_click');
});



api.ready(async () => {

});

</script>

<div id="top">
  <santa-weather></santa-weather>
  <div class="village">
    <div class="layer1"></div>
    <div class="layer2"></div>
    <div class="layer3"></div>
    <div class="layer4"></div>
  </div>
  <header>
    <div class="ornament"></div>
    <svg class="google"><path d="M7.74363885 18.01859504v2.03305785h4.98714095c-.1526676 1.14049591-.5428181 1.97520661-1.1365254 2.56198351-.7294117.7107438-1.86593703 1.4876033-3.85061555 1.4876033-3.07031464 0-5.47058823-2.4132232-5.47058823-5.40495871 0-2.99173554 2.40027359-5.40495868 5.47058823-5.40495868 1.65389877 0 2.86675785.63636364 3.75731875 1.45454546l1.4673051-1.42975207C11.729959 12.14256198 10.0675787 11.25 7.74363885 11.25 3.53679891 11.25 0 14.58884298 0 18.68801653c0 4.09917357 3.53679891 7.43801657 7.74363885 7.43801657 2.27305065 0 3.98632015-.7272728 5.32640215-2.0826447 1.3740082-1.3388429 1.8065664-3.2314049 1.8065664-4.75206609 0-.47107438-.0339261-.90909091-.1102599-1.27272727H7.74363885zm13.36689465-1.65289256c-2.7225718 0-4.9447332 2.01652892-4.9447332 4.80165292 0 2.7603306 2.2221614 4.8016529 4.9447332 4.8016529s4.9447333-2.0330579 4.9447333-4.8016529c0-2.785124-2.2221615-4.80165292-4.9447333-4.80165292zm0 7.71074382c-1.4927496 0-2.7819425-1.1983471-2.7819425-2.9090909 0-1.72727276 1.2891929-2.90909094 2.7819425-2.90909094 1.4927497 0 2.7819426 1.18181818 2.7819426 2.90909094 0 1.7107438-1.2891929 2.9090909-2.7819426 2.9090909zm24.2402189-6.63636366h-.0763338c-.4834473-.56198347-1.4164159-1.07438016-2.5953488-1.07438016-2.4596444 0-4.605472 2.09090909-4.605472 4.80165292 0 2.6942148 2.1458276 4.8016529 4.605472 4.8016529 1.1789329 0 2.1119015-.5123967 2.5953488-1.0909091h.0763338v.6694215c0 1.8347107-1.0093023 2.8181818-2.629275 2.8181818-1.323119 0-2.1458276-.9256199-2.4850889-1.7107438l-1.8829001.7603306c.542818 1.2727272 1.976197 2.8347107 4.367989 2.8347107 2.5359781 0 4.6818058-1.4545455 4.6818058-5v-8.63636364h-2.0525308v.82644628zm-2.4850889 6.63636366c-1.4927497 0-2.629275-1.2396694-2.629275-2.9090909 0-1.6942149 1.1365253-2.90909094 2.629275-2.90909094 1.4757866 0 2.6292749 1.23966942 2.6292749 2.92561984.0084816 1.6776859-1.1534883 2.892562-2.6292749 2.892562zm-10.7291382-7.71074382c-2.7225718 0-4.9447332 2.01652892-4.9447332 4.80165292 0 2.7603306 2.2221614 4.8016529 4.9447332 4.8016529s4.9447332-2.0330579 4.9447332-4.8016529c0-2.785124-2.2221614-4.80165292-4.9447332-4.80165292zm0 7.71074382c-1.4927497 0-2.7819425-1.1983471-2.7819425-2.9090909 0-1.72727276 1.2891928-2.90909094 2.7819425-2.90909094s2.7819426 1.18181818 2.7819426 2.90909094c0 1.7107438-1.2891929 2.9090909-2.7819426 2.9090909zm16.9630643-12.6280992h2.1288646v14.5206612h-2.1288646V11.4483471zm8.702052 12.6280992c-1.1025992 0-1.8829001-.4876033-2.3917921-1.4545455L62 19.96900826l-.2205198-.54545454c-.4071136-1.07438017-1.6623803-3.05785124-4.2153215-3.05785124-2.5359781 0-4.6478796 1.94214876-4.6478796 4.80165292 0 2.6942148 2.0864569 4.8016529 4.8853625 4.8016529 2.2560875 0 3.5622435-1.3471075 4.1050615-2.123967l-1.6793433-1.0909091c-.5597811.7933885-1.323119 1.3223141-2.4257182 1.3223141zm-.1526676-5.90909093c.8735978 0 1.6199726.43801653 1.8659371 1.05785124L55.0621067 21.018595c0-2.01652888 1.4673051-2.85123963 2.5868673-2.85123963z"/></svg>
    <h1 msgid="santatracker"></h1>
    <p msgid="village_explore"></p>
    <button id="play"><span msgid="play"></span></button>
  </header>
  <div id="newtoday">
    <span msgid="newtoday"></span>
    <santa-card scene="elfmaker"></santa-card>
  </div>
</div>

<div id="modules">
  <div class="sidebar left"></div>
  <main>
<modvil-module id="android" color="#9b643d" parts="static-svg,loop,static-png,loop">

</modvil-module>
<modvil-module id="transithub" color="#d4f1fe" parts="static-svg,loop,scroll">
  <santa-card id="jetpack"></santa-card>
  <santa-card id="elfmaker"></santa-card>
  <santa-card id="santasearch"></santa-card>
</modvil-module>
<modvil-module id="sciencelab" color="#3499ff" parts="static-svg,loop,scroll">
  <santa-card id="codelab"></santa-card>
  <santa-card id="gumball"></santa-card>
  <santa-card id="snowbox"></santa-card>
</modvil-module>
<modvil-module id="toymaking" color="#00c1f2" parts="static-svg,static-svg,scroll,static-svg">
  <santa-card id="presentbounce"></santa-card>
  <santa-card id="build"></santa-card>
  <santa-card id="santaselfie"></santa-card>
</modvil-module>
<modvil-module id="kitchen" color="#fdb0ca" parts="static-svg,loop,static-svg,scroll">
  <santa-card id="traditions"></santa-card>
  <santa-card id="translations"></santa-card>
  <santa-card id="presentdrop"></santa-card>
</modvil-module>
<modvil-module id="nursery" color="#6bb4fd" parts="static-svg,loop,scroll">
  <santa-card id="speedsketch"></santa-card>
  <santa-card id="santascanvas"></santa-card>
  <santa-card id="storybook"></santa-card>
</modvil-module>
<modvil-module id="greenhouse" color="#94dae4" parts="static-svg,loop,scroll,static-svg">
  <santa-card id="snowball"></santa-card>
  <santa-card id="elfski"></santa-card>
  <santa-card id="penguindash"></santa-card>
</modvil-module>
<modvil-module id="movies" color="#6900ff" parts="static-png,loop">
  <!-- TODO: movies -->
</modvil-module>
<modvil-module id="wrapping" color="#5203c0" parts="static-svg,loop,scroll,static-svg">
  <santa-card id="boatload"></santa-card>
  <santa-card id="seasonofgiving"></santa-card>
  <santa-card id="racer"></santa-card>
</modvil-module>
<modvil-module id="disco" color="#e5e5e5">
  <santa-card id="codeboogie"></santa-card>
  <santa-card id="jamband"></santa-card>
  <santa-card id="wrapbattle"></santa-card>
</modvil-module>
<modvil-module id="training" color="#e5e5e5">
  <santa-card id="mercator"></santa-card>
  <santa-card id="glider"></santa-card>
  <santa-card id="runner"></santa-card>
</modvil-module>

<modvil-module id="footer" color="#8ab8d4" parts="static-svg"></modvil-module>
  </main>
  <div class="sidebar right"></div>
</div>

<footer>
</footer>

</body>
</html>

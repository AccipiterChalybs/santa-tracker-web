<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lobster|Google+Sans:400,500,700" />
  <link rel="stylesheet" href="index.css" />

  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
</head>
<body>

<script type="module">
import api from '../../src/scene/api.js';
import '../../src/polyfill/css.js';  // FIXME: should be included centrally?
import '../../src/elements/santa-card.js';
import '../../src/elements/santa-weather.js';
import * as helpers from './helpers.js';
import {loadAnimation} from '../../src/deps/lottie.js';


api.preload.sounds('village_load_sounds');
api.preload.sounds('elfmaker_load_sounds');  // TODO: for generic_button_click
api.config({
  scroll: true,
  sound: ['music_start_village', 'village_start'],
});


/**
 * Describes each village module and its static/animated parts.
 */
const moduleDefs = [
  {
    id: 'transithub',
    parts: ['static', 'loop', 'scroll'],
  },
  {
    id: 'sciencelab',
    parts: ['static', 'loop', 'scroll'],
  },
  {
    id: 'kitchen',
    parts: ['static', 'loop', 'static', 'scroll'],
  },
  {
    id: 'greenhouse',
    parts: ['static', 'loop', 'scroll', 'static'],
  },
  {
    id: 'nursery',
    parts: ['static', 'loop', 'scroll'],
  },
  {
    id: 'toymaking',
    parts: ['static', 'static', 'scroll', 'static'],
  },
  {
    id: 'wrapping',
    parts: ['static', 'loop', 'scroll', 'static'],
  },
  {
    id: 'android',
    parts: ['static', 'loop'],
  }
];

/**
 * Finds the ratio of scrolling that this element should display at.
 */
function ratioForModule(el) {
  const se = document.scrollingElement;
  const topScroll = se.scrollTop;

  // The start of this element is effectively min window height (can't scroll above this point).
  const effectiveStart = Math.max(0, el.offsetTop - window.innerHeight);
  const effectiveEnd = Math.min(se.offsetHeight - window.innerHeight, el.offsetTop + el.offsetHeight);

  const ratio = (topScroll - effectiveStart) / (effectiveEnd - effectiveStart);

  if (ratio <= 0.0) {
    return 0.0;
  } else if (ratio >= 1.0) {
    return 1.0;
  }

  // This creates more of a cubic-bezier style transform (although it's quite subtle).
  return (Math.sin((ratio - 0.5) * Math.PI) + 1) * 0.5;
}

function moduleIsVisible(el) {
  const se = document.scrollingElement;
  const top = se.scrollTop;
  const bottom = se.scrollTop + window.innerHeight;

  if (el.offsetTop + window.innerHeight >= top) {
    return el.offsetTop < bottom;
  }
}

async function prepareModules() {
  const main = document.querySelector('main');
  const scrollables = new Map();

  for (const {id, parts} of moduleDefs) {
    const container = document.createElement('div');
    container.className = 'module';
    container.setAttribute('id', `module--${id}`);
    main.append(container);

    const animations = parts.map((type, index) => {
      const base = `img/modules/${id}/${index}`;
      const zIndex = -(100 - index);

      if (type === 'static') {
        const img = document.createElement('img');
        img.src = `${base}.svg`;
        container.append(img);
        img.style.zIndex = zIndex;
        // TODO: preload
        return null;
      }

      const options = {
        container,
        loop: (type === 'loop'),
      };
      const anim = loadAnimation(`${base}.json`, options);
      anim.renderer.svgElement.style.zIndex = zIndex;

      // TODO: preload
      return anim;
    }).filter(Boolean);

    scrollables.set(container, animations);
  }

  helpers.installAdjustHandler(() => {
    scrollables.forEach((animations, container) => {
      const visible = moduleIsVisible(container);
      const ratio = visible ? ratioForModule(container) : -1.0;

      animations.forEach((anim) => {
        if (anim.loop) {
          // This should loop, but only if visible.
          if (visible === anim.isPaused) {
            return;  // nothing to do
          }
          visible ? anim.play() : anim.pause();
          return;
        }

        if (!visible) {
          return;
        }

        // Otherwise, this is a scroll target.
        const frames = anim.getDuration(true);
        const frame = Math.min(frames, Math.max(0.0, frames * ratio));
        anim.goToAndStop(frame, true);
      });
    });
  });
}

api.preload.wait(prepareModules());

const playButton = document.getElementById('play');

playButton.addEventListener('click', (ev) => {
  playButton.classList.add('active');
  api.go('codelab');
});
playButton.addEventListener('mousedown', () => {
  api.play('generic_button_click');
});
playButton.addEventListener('touchdown', () => {
  api.play('generic_button_click');
});



api.ready(async () => {

});

</script>

<div id="top">
  <santa-weather></santa-weather>
  <header>
    <div id="ornament"></div>
    <h1 msgid="santatracker"></h1>
    <button id="play"><span msgid="play"></span></button>
  </header>
  <div id="newtoday">
    <span msgid="newtoday"></span>
    <santa-card scene="elfmaker"></santa-card>
  </div>
</div>

<div id="modules">
  <div class="sidebar left"></div>
  <main></main>
  <div class="sidebar right"></div>
</div>

</div>

</body>
</html>

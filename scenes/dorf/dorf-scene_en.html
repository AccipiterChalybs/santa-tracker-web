<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->

<link rel="import" href="../scene-behavior.html">
<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../elements/santa-strings.html">
<link rel="import" href="../../elements/weather/santa-weather.html">
<link rel="import" href="../../elements/santa-state.html">
<link rel="import" href="../../elements/village-header/village-header.html">
<link rel="import" href="elements/effect-snowmobile.html">
<link rel="import" href="elements/effect-tictactoe.html">
<link rel="import" href="elements/effect-wrangler.html">
<link rel="import" href="elements/village-house.html">
<link rel="import" href="dorf-scene_module.html">

<!--
Santa's Village.
-->
<dom-module id="dorf-scene">
<template strip-whitespace>
  <style include="dorf-scene_module"></style>

  <santa-strings strings="{{strings}}"></santa-strings>

  <santa-state countdown-finished="{{_countdownFinished}}"
      during-tracker="{{_duringTracker}}"
      remaining-time="{{_remainingTime}}"></santa-state>

  <village-header nobranding remaining-time="[[_remainingTime]]"
      class$="[[_computeHeaderClass(_countdownFinished, _duringTracker)]]">
    <p>
      <i18n-msg msgid="village_explore">PLACEHOLDER_i18n</i18n-msg>
    </p>

    <div class="options">
      <button class="button" href$="[[urlFor('tracker')]]">
        <i18n-msg msgid="tracker_track">PLACEHOLDER_i18n</i18n-msg>
      </a>
      <button id="play" hidden$="[[_playHidden]]" on-click="_onClickPlayRound">
        <span><i18n-msg msgid="play">PLACEHOLDER_i18n</i18n-msg></span>
      </button>
    </div>

    <div slot="effects" id="effect-sun"></div>
    <santa-weather slot="effects"></santa-weather>
    <div slot="effects" id="effect-plane"></div>
  </village-header>

  <div id="mobiletext">
    <p>
      <i18n-msg msgid="village_explore">PLACEHOLDER_i18n</i18n-msg>
    </p>
  </div>

  <!-- Actual house links -->
  <div id="links" on-mouseover="_onHousesOver" on-mouseout="_onHousesOut">
    <template is="dom-repeat" items="[[houses]]">
      <a class="link"
          target$="[[_calculateTarget(item.link)]]"
          href$="[[_calculateHref(item.link, item.module, item.locked)]]"
          house$="[[item.module]]"
          style$="[[_computeLinkStyle(item.module, item.launchDate)]]">
        <div class="card">
          <h4>[[_string('category', item.category, strings)]]</h4>
          <h3>[[_string('scene', item.module, strings)]]</h3>
        </div>
      </a>
    </template>
  </div>

  <!-- Interactive village at >768px or above -->
  <iron-media-query query="(min-width: 768px)"
      query-matches="{{_isSceneVillage}}"></iron-media-query>
  <template is="dom-if" if="[[_isSceneVillage]]" restamp>
    <div id="village-all">
      <div id="background"></div>
      <div id="eastereggs">
        <template is="dom-repeat" items="[[easterEggs]]">
          <div id$="easteregg-[[item]]"></div>
        </template>

        <div id="easteregg-white-board">
          <a href="[[urlFor('briefing')]]"></a>
        </div>

        <div id="easteregg-schoolyard">
          <div class="slide"></div>
          <div class="seesaw"></div>
          <div class="swing"></div>
          <a href="[[urlFor('playground')]]"></a>
        </div>

        <div id="easteregg-balloon" class="random clickable" on-click="_flyBalloon"></div>
        <div id="easteregg-balloon-ropes"></div>
        <div id="easteregg-balloon-flight"></div>

        <effect-snowmobile id="easteregg-snowmobile1" class="clickable"></effect-snowmobile>
        <effect-snowmobile id="easteregg-snowmobile2" class="clickable"></effect-snowmobile>
        <effect-snowmobile id="easteregg-snowmobile3" class="clickable"></effect-snowmobile>
        <effect-snowmobile id="easteregg-snowmobile4" class="clickable"></effect-snowmobile>

        <div id="easteregg-busstop1" class="random clickable" on-click="_triggerBus">
          <div class="elf-stop elf-purple"></div>
          <div class="elf-stop elf-yellow"></div>
          <div class="elf-stop elf-red"></div>
          <div class="elf-stop elf-blue"></div>
          <div class="elf-stop biz-snowman"></div>
          <div class="bus">
            <div class="snowman-bus"></div>
            <div class="elf-bus elf-bus--red"></div>
            <div class="elf-bus elf-bus--purple"></div>
            <div class="elf-bus elf-bus--yellow"></div>
            <div class="elf-bus elf-bus--blue"></div>
          </div>
        </div>

        <div id="easteregg-busstop2" class="random clickable" on-click="_triggerBus">
          <div class="elf-stop elf-blue"></div>
          <div class="elf-stop elf-purple"></div>
          <div class="bus">
            <div class="elf-bus elf-bus--blue"></div>
            <div class="elf-bus elf-bus--purple"></div>
            <div class="elf-bus"></div>
          </div>
        </div>

        <div id="easteregg-busstop3" class="random clickable" on-click="_triggerBus">
          <div class="elf-stop elf-sit"></div>
          <div class="elf-stop elf-yellow"></div>
          <div class="elf-stop elf-blue"></div>
          <div class="bus">
            <div class="elf-bus elf-bus--sit"></div>
            <div class="elf-bus elf-bus--yellow"></div>
            <div class="elf-bus elf-bus--blue"></div>
            <div class="elf-bus"></div>
          </div>
        </div>

        <effect-tictactoe id="easteregg-tictactoe"></effect-tictactoe>
        <effect-wrangler id="easteregg-wrangler"
            class="clickable"
            href="[[urlFor('windtunnel')]]"></effect-wrangler>
      </div>
      <div id="houses" class="cells">
        <template is="dom-repeat" items="[[houses]]">
          <div class="cell">
            <village-house house="[[item.module]]" locked="[[item.locked]]"></village-house>
          </div>
        </template>
      </div>
    </div>
  </template>

  <footer class$="[[_computeCountdownFinishedClass(_countdownFinished)]]">
    <p hidden$="[[_countdownFinished]]"><i18n-msg msgid="village_comeback">PLACEHOLDER_i18n</i18n-msg></p>
  </footer>

</template>
<script>
(function() {

  var RANDOM_EGG_WAIT_MIN = 5000;
  var RANDOM_EGG_WAIT_MAX = 30000;

  var EASTER_EGGS = ['tree', 'blocks', 'statue', 'penguin-revolt',
      'snowman-reading', 'rosetta-stone',
      'book-club', 'unicycle', 'walrus'];

  Polymer({
    is: 'dorf-scene',

    behaviors: [window.SantaSceneBehavior],

    properties: {

      houses: {
        type: Array,
        value: null,
      },

      /** Easter eggs helper, used for template. */
      easterEggs: {
        type: Array,
        readOnly: true,
        value: Object.freeze(EASTER_EGGS),
      },

      _dec4th: {
        type: String,
        value: computeDateName('December 4'),
      },

      _playHidden: {
        type: Boolean,
      },

      /** Whether this is the full village. Used to control stamping of easter eggs. */
      _isSceneVillage: {
        type: Boolean,
      },

      /** Bound from `santa-state`, whether the countdown is done. */
      _countdownFinished: {
        type: Boolean,
      },

      /** Bound from `santa-state`, whether we are during the tracker. */
      _duringTracker: {
        type: Boolean,
      },

      /** Bound from `santa-state`, the remaining time. */
      _remainingTime: {
        type: Number,
      },

      /** Strings bound from `santa-strings`. */
      strings: Object,
    },

    _computeHeaderClass: function(countdownFinished, duringTracker) {
      if (countdownFinished) {
        if (duringTracker) {
          return 'track notext';
        }
        return 'notext';
      }
      return '';
    },

    _computeCountdownFinishedClass: function(finished) {
      return finished ? 'countdown-finished': '';
    },

    _computeIsSceneVillage: function(screenWidth) {
      return screenWidth >= 768;
    },

    _calculateTarget: function(link) {
      return link ? '_blank' : null;
    },

    /**
     * Calculates the href to load for this house.
     */
    _calculateHref: function(link, module, locked) {
      if (locked) {
        return null;
      }
      return link || this.urlFor(module) || null;
    },

    /**
     * Returns the string from the passed Object in the form `type-id`. Used
     * to look up dynamic strings.
     */
    _string: function(type, id, strings) {
      return strings ? strings[type + '-' + id] : null;
    },

    _onHousesOver: function(event) {
      if (!event.target || event.target.localName !== 'a' || !event.target.href) {
        return;
      }
      this.fire('sound-trigger', 'village_bubble_appear');
    },

    _onHousesOut: function(event) {
      if (!event.target || !event.target.classList.contains('card')) {
        return;
      }
      this.fire('sound-trigger', 'village_bubble_disappear');
    },

    /**
     * Helper method. Just does equality.
     */
    _equals: function(a, b) {
      return a === b;
    },

    onPreload: function() {
      this.preloadSounds('village_load_sounds');
      this.preloadImages([
        'img/sun.svg',
      ]);

      if (this._isSceneVillage) {
        this.preloadImages([
          'img/road.svg',
          'img/ground.svg',
        ]);
      } else {
        this.preloadImages([
          'img/mobile-elf1.svg',
          'img/mobile-elf2.svg',
        ]);
      }

      // Preload the first ~7 houses.
      for (var i = 0; i < 7 && i < this.houses.length; ++i) {
        var house = this.houses[i];
        var id = house.module;

        var preload = [];

        if (this._isSceneVillage) {
          preload.push('img/building/' + id + '.svg');
        }
        preload.push('../../images/scenes/' + id + '_2x.png');
        if (house.locked && this._isSceneVillage) {
          preload.push('img/building/' + id + '-ice.svg')
        }
        this.preloadImages(preload);
      }

    },

    created: function() {
      const t = window.santaApp;

      this._refreshHouseData = () => {
        this._playHidden = !(t.nextRandom);
        this.houses = t.houses.map((house) => {
          return {
            locked: !t.sceneIsOpen(house.module),
            module: house.module,
            link: house.link,
            launchDate: house.launchDate,
            category: house.category,
          };
        });
      };
      this._refreshHouseData();
    },

    attached: function() {
      const t = window.santaApp;
      t.addEventListener('houses-changed', this._refreshHouseData);
      this._refreshHouseData();
    },

    detached: function() {
      const t = window.santaApp;
      t.removeEventListener('houses-changed', this._refreshHouseData);
    },

    onShow: function() {
      this.fire('sound-ambient', 'music_start_village');
      this.fire('sound-ambient', 'village_start');
      this._randomEasterEggs();
    },

    onHide: function() {
      this.fire('sound-ambient', 'village_end');
      this.cancelDebouncer('easteregg');
    },

    _onClickPlayRound: function() {
      window.santaApp.fire('random');
      window.ga('send', 'event', 'village', 'click', 'play-round');
    },

    /**
     * Computes the CSS variables for the given module.
     */
    _computeLinkStyle: function(id, launchDate) {
      const parts = [];

      // TODO(samthor): Remove `window.santaApp` refs and instead include this in the CSS.
      const color = window.santaApp.colorForRoute(id);
      if (color) {
        parts.push(`--scene-color: ${color}`);
      }

      return parts.join(';');
    },

    /** NOTE: easteregg code only below this point */

    _randomEasterEggs: function() {
      this.debounce('easteregg', function() {
        if (!this.isAttached) { return; }
        this._randomEasterEggs();

        const eggs = Polymer.dom(this.root).querySelectorAll('#eastereggs .random');
        if (!eggs.length) { return; }

        const choice = eggs[Math.floor(Math.random() * eggs.length)];
        const bounds = choice.getBoundingClientRect();
        if (!bounds.width && !bounds.height) { return; }

        choice.click();
      }, randomRange(RANDOM_EGG_WAIT_MIN, RANDOM_EGG_WAIT_MAX));
    },

    _flyBalloon: function(e) {
      if (e.isTrusted || e.screenX) {
        window.ga('send', 'event', 'village', 'click', 'balloon');
      }

      var FLIGHT_TIME = 30000;

      // nb. these may not start on the page
      const dom = Polymer.dom(this.root);
      var balloon = dom.querySelector('#easteregg-balloon');
      var balloonRopes = dom.querySelector('#easteregg-balloon-ropes');
      var balloonFlight = dom.querySelector('#easteregg-balloon-flight');
      if (!balloon || balloon.classList.contains('flying')) { return; }

      this.fire('sound-trigger', 'village_balloon_click');

      balloon.classList.add('flying');
      balloonRopes.classList.add('flying');
      balloonFlight.classList.add('flying');
      this.async(function() {
        balloon.classList.remove('flying');
        balloonRopes.classList.remove('flying');
        balloonFlight.classList.remove('flying');
      }, FLIGHT_TIME + 1);
    },

    _triggerBus: function(e) {
      if (e.isTrusted || e.screenX) {
        window.ga('send', 'event', 'village', 'click', 'bus');
      }

      var BUS_DRIVE_ANIMATION = 10000;
      var BUS_LOAD_ANIMATION = 3000;
      var busStop = e.currentTarget;
      if (busStop.classList.contains('to-stop') ||
          busStop.classList.contains('from-stop')) {
        return;
      }

      busStop.classList.add('to-stop');
      this.async(function() {
        if (busStop.classList.contains('bus-load')) {
          busStop.classList.remove('bus-load');
        } else {
          busStop.classList.add('bus-load');
        }
        this.async(function() {
          busStop.classList.remove('to-stop');
          busStop.classList.add('from-stop');

          this.async(function() {
            busStop.classList.remove('from-stop');
          }, BUS_DRIVE_ANIMATION + 1);
        }, BUS_LOAD_ANIMATION + 1);
      }, BUS_DRIVE_ANIMATION + 1);
    },

  });
})();
</script>
</template>
</dom-module>

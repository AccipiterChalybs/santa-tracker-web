<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../santa-state.html">
<link rel="import" href="countdown-timer_module.html">

<!--
Displays a timer.

Example

    <countdown-timer>
      <h3 slot="days">Days</h3>
      <h3 slot="hours">Hours</h3>
      <h3 slot="minutes">Minutues</h3>
      <h3 slot="seconds">Seconds</h3>
    </countdown-timer>
-->
<dom-module id="countdown-timer">
  <template>
    <style include="countdown-timer_module">
      :host {
        display: block;
        will-change: transform;
        transform: translateZ(0);
      }

      #counter {
        @apply --layout-horizontal;
      }
    </style>

    <div id="counter">
      <div class="counter-box" hidden$="[[_daysHidden]]">
        <div class="holder active"></div>
        <div class="holder prev"></div>
        <div class="bottom">
          <slot name="days"></slot>
        </div>
      </div>
      <div class="counter-box">
        <div class="holder active"></div>
        <div class="holder prev"></div>
        <div class="bottom">
          <slot name="hours"></slot>
        </div>
      </div>
      <div class="counter-box">
        <div class="holder active"></div>
        <div class="holder prev"></div>
        <div class="bottom">
          <slot name="minutes"></slot>
        </div>
      </div>
      <div class="counter-box">
        <div class="holder active"></div>
        <div class="holder prev"></div>
        <div class="bottom">
          <slot name="seconds"></slot>
        </div>
      </div>
    </div>

  </template>
  <script>
  (function() {

    var _TRANSITION_TIME = 400;

    Polymer({
      is: 'countdown-timer',

      properties: {

        /**
         * True if the countdown should animate.
         */
        animate: {
          type: Boolean,
          value: true,
        },

        /**
         * True if the countdown should be active.
         */
        active: {
          type: Boolean,
          value: false,
          observer: '_activeChanged',
        },

        /**
         * Whether the "Days" counter is hidden.
         */
        _daysHidden: {
          type: Boolean,
          value: false,
        },

        /**
         * The `.counter-box` elements containing countdown nodes.
         */
        holders: {
          type: Array,
          value: function() { return []; },
          readOnly: true,
        },

        /**
         * Remaining time. This will tick at a rate of 1s/s
         */
        remainingTime: {
          type: Number,
          observer: '_remainingTimeChanged',
        },

        /**
         * The time at which remainingTime was set.
         */
        _remainingTimeSetAt: Number,
      },

      _oldNumbers: [],  // replaced in tickTock
      _tickInterval: 0,

      attached: function() {
        Polymer.RenderStatus.afterNextRender(this, function() {
          // Needs to wait one rAF so titles has populated the template repeat.
          this._setHolders(Array.prototype.slice.call(this.$.counter.children));
          this._activeChanged();
        });
      },

      detached: function() {
        window.clearInterval(this._tickInterval);
      },

      _remainingTimeChanged: function() {
        this._remainingTimeSetAt = Date.now();
      },

      _activeChanged: function() {
        window.clearInterval(this._tickInterval);

        if (this.active && this.isAttached && this.remainingTime >= 0) {
          this._tickTock();
          this._tickInterval = window.setInterval(this._tickTock.bind(this), 1000);
        }
      },

      /**
       * Called every second while remainingTime is greater or equal to zero, active is true, and
       * this element is attached. Calculates the current local remainingTime and stops the ticker
       * if that is zero or below.
       */
      _tickTock: function() {
        var delta = Date.now() - this._remainingTimeSetAt;
        var remainingTime = this.remainingTime - delta;

        if (remainingTime <= 0) {
          window.clearInterval(this._tickInterval);
          remainingTime = 0;
        }
        this._render(remainingTime);
      },

      /**
       * Renders the specified local remaining time. This does not use the remainingTime from this
       * object directly.
       */
      _render: function(remainingTime) {
        var parts = countdownSplit(remainingTime);

        var days = parts.days;
        var hours = parts.hours;
        var minutes = parts.minutes;
        var seconds = parts.seconds;

        var numbers = [padDigits(days), padDigits(hours), padDigits(minutes), padDigits(seconds)];
        this._daysHidden = (days <= 0);

        // Ensure holders exist. Solves inconsistent asyncs.
        if (this.holders.length) {
          for (var i = 0, holder; holder = this.holders[i]; ++i) {
            this.setValue(holder, this._oldNumbers[i], numbers[i]);
          }
          this._oldNumbers = numbers;
        }
      },

      /**
       * Sets a value for the passed `.counter-box` node.
       */
      setValue: function(node, oldVal, val) {
        if (oldVal === val) {
          return;
        }

        // NOTE: Assumes child layout.
        node.children[0].textContent = val || '';

        if (this.animate) {
          node.children[1].textContent = oldVal || '';

          node.classList.add('anim');
          this.async(function() {
            node.classList.remove('anim');
          }, _TRANSITION_TIME * 2);
        }
      },

    });

  })();
  </script>
</dom-module>

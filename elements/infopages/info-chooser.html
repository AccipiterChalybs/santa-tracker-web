<!--
Copyright 2017 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">

<!--
Chooser that shows a selection of multiple different cards. Sets the `.hidden` property
on cards if they are to be made hidden. Hard-coded to work on `info-card`.
-->
<dom-module id="info-chooser">
<template>
  <style>

    #chooser {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      padding: 0 8px 46px;
    }

    input {
      opacity: 0;
      position: absolute;
    }

    label div {
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      padding: 16px;
      position: relative;
      text-transform: uppercase;
      z-index: 1;
      display: inline-block;
      border-radius: 8px;
      background: transparent;
      color: var(--info-chooser-background, #9575cd);
      margin: 2px;
      border: 2px solid transparent;
    }

    label input:checked + div {
      background: var(--info-chooser-background, #9575cd);
      color: var(--info-chooser-color, white);
    }
    label input:active + div,
    label input:focus + div {
      border-color: rgba(0, 0, 0, 0.33);
    }

    #container {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
    }

  </style>

  <div id="chooser" on-change="_onChoiceChanged">
    <template is="dom-repeat" items="[[_choices]]" as="choice" on-dom-change="_updateInput">
      <label>
        <input type="radio" name="chooser" value="[[choice]]" />
        <div>[[_computeChoiceName(choice)]]</div>
      </label>
    </template>
  </div>

  <div id="container">
    <slot></slot>
  </div>

</template>
<script>
(function() {

const spaceRe = /\s+/;

// nb. we hard-code a list of filter names for now
const names = {
  '': 'View All',
  'education': 'Education Focused',
  'android': 'Android',
  'new': 'New This Year',
  'geography': 'Geography',
  'computerscience': 'Computer Science',
  'language': 'Language',
  'socialstudies': 'Social Studies',
  'lang_en': 'English',
  'lang_es': 'Español',
  'lang_fr': 'Français',
  'lang_ja': '日本語',
  'lang_ko': '한국어',
};

Polymer({
  is: 'info-chooser',

  properties: {

    _choices: {
      type: Object,
      computed: '_computeChoicesArray(choices, hideAll)',
    },

    /**
     * Whether to hide the "Show All" button.
     */
    hideAll: {
      type: Boolean,
      value: false,
    },

    /**
     * The space-separated listed of filter options available to the user.
     */
    choices: {
      type: String,
      value: '',
    },

    /**
     * The chosen option.
     */
    value: {
      type: String,
      notify: true,
      value: '',
    },

    /**
     * Use this attribute of slotted nodes to determine whether to make the nodes visible.
     */
    attributeForFilter: {
      type: String,
      value: 'filter',
    },

  },

  observers: [
    '_updateInput(value, choices)',
    '_updateSelection(value, attributeForFilter)',
  ],

  // nb. we don't observe this element's DOM contents; so .hidden isn't updated as more elements
  // are added and removed.

  _onChoiceChanged: function(ev) {
    this.value = ev.target.value;
  },

  _updateInput: function() {
    const opts = this.$.chooser.querySelectorAll('input');
    for (let i = 0; i < opts.length; ++i) {
      opts[i].checked = (opts[i].value === this.value);
    }
  },

  _computeChoicesArray: function(choices, hideAll) {
    const array = choices.split(spaceRe);
    if (array[0] !== '' && !hideAll) {
      array.unshift('');
    }
    return Object.freeze(array);
  },

  _computeChoiceName: function(choice) {
    return names[choice] || choice;
  },

  attached: function() {
    this._observer = Polymer.dom(this).observeNodes(this._updateSelection);
  },

  detached: function() {
    Polymer.dom(this).unobserveNodes(this._observer);
  },

  _updateSelection: function() {
    const value = this.value;
    const attributeForFilter = this.attributeForFilter;
    const nodes = Polymer.dom(this).queryDistributedElements('info-card');
    for (let i = 0; i < nodes.length; ++i) {
      const node = nodes[i];
      if (!value) {
        node.hidden = false;
        continue;
      }
      const parts = (node.getAttribute(attributeForFilter) || '').split(spaceRe);
      node.hidden = (parts.indexOf(value) === -1);
    }
  },

});

})();
</script>
</dom-module>

<!--
Copyright 2016 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/iron-icon/iron-icon.html">
<link rel="import" href="../santa-app-behavior.html">
<link rel="import" href="../santa-icons.html">
<link rel="import" href="santa-overlay_module.html">

<!--
Shared overlay for Santa Tracker games.
-->
<dom-module id="santa-overlay">
<template>
  <style include="santa-overlay_module"></style>

  <div hidden>
    <!-- preloader -->
    <img src="[[_computeHeroUrl(hero)]]" />
  </div>

  <div id="main">
    <div id="hero"
        style$="[[_computeBackgroundStyle(hero)]]"
        class$="[[_computeHeroClass(score, shareUrl)]]">
      <div class="score" hidden$="[[_computeScoreHidden(score)]]">
        <h2><i18n-msg msgid="gameover">PLACEHOLDER_i18n</i18n-msg></h3>
        <div hidden$="[[!score]]">[[score]]</div>
      </div>
    </div>
    <div id="controls">
      <div class="url" hidden$="[[!shareUrl]]">
        <h4><i18n-msg msgid="copy-me-short">PLACEHOLDER_i18n</i18n-msg></h4>
        <div class="link" on-click="_selectUrl">[[_shortShareUrl]]</div>
      </div>
      <section class="Buttons">
        <button hidden$="[[!_canResume]]" on-click="_onResumeClick" class="Button Button--round Button--play"></button>
        <button on-click="_onPlayAgainClick" class="Button Button--round Button--refresh"></button>
        <button on-click="_onHomeClick" class="Button Button--round Button--home"></button>
        <button on-click="_onNextClick" class="Button Button--text">
          <h3>
            <i18n-msg msgid="next_game">PLACEHOLDER_i18n</i18n-msg>
          </h3>
        </button>
      </section>
    </div>
  </div>

</template>
<script>
(function() {

function shortenUrl(url, cb) {
  const key = 'AIzaSyA4LaOn5d1YRsJIOTlhrm7ONbuJ4fn7AuE';

  return new Promise((resolve, reject) => {
    const x = new XMLHttpRequest();
    x.open('POST', 'https://www.googleapis.com/urlshortener/v1/url?key=' + key);
    x.responseType = 'json';
    x.onload = () => resolve(x.response['id'] || url);
    x.onerror = () => reject(x.responseText);
    x.setRequestHeader('Content-Type', 'application/json');
    x.send(JSON.stringify({longUrl: url}));
  });
}

Polymer({
  is: 'santa-overlay',
  behaviors: [window.SantaAppBehavior],

  properties: {

    /** Score to display. Shows a "Game Over" message if non-null. */
    score: {
      type: Number,
      value: null,
    },

    /** Whether to show the resume button, because the game can be paused. */
    hasPause: {
      type: Boolean,
      value: false,
    },

    /** Custom URL to share. Will be automagically shortened. */
    shareUrl: {
      type: String,
      value: null,
      observer: '_shareUrlChanged',
    },

    /** Custom hero image to use for a share/gameover screen. */
    hero: {
      type: String,
      value: null,
    },

    /** Short version of the shareUrl. Generated automagically. */
    _shortShareUrl: {
      type: String,
    },

    _canResume: {
      computed: '_computeCanResume(score, hasPause)',
    },

  },

  ready: function() {
    this.addEventListener('click', (ev) => {
      const target = ev.path && ev.path[0] || ev.target || null;
      if (this.$.main !== target && this.$.main.contains(target)) {
        return;
      }
      if (this._canResume) {
        this.fire(this.hasPause ? 'game-resume' : 'game-restart');
        window.ga('send', 'event', 'overlay', 'click', 'background');
      }
      ev.preventDefault();
    });
  },

  _computeScoreHidden: function(score) {
    return score == null;  // check for null/undefined, zero is valid score
  },

  _computeCanResume: function(score, hasPause) {
    return score == null && hasPause;
  },

  _computeHeroClass: function(score, shareUrl) {
    if (shareUrl) {
      return 'share';
    } else if (score == null) {
      return 'pause';
    } else {
      return '';  // gameover
    }
  },

  _shareUrlChanged: function(newValue) {
    this._shortShareUrl = null;
    if (!this.shareUrl) {
      return;
    }

    window.ga('send', 'event', 'overlay', 'share', 'url');

    shortenUrl(this.shareUrl).catch((err) => {
      console.warn('couldn\'t shorten URL', err);
      return newValue;
    }).then((url) => {
      if (this.shareUrl !== newValue) {
        return;
      }
      this._shortShareUrl = url;
    });
  },

  _selectUrl: function(ev) {
    ev.preventDefault();
    window.getSelection().selectAllChildren(ev.target);
    document.execCommand('copy');
  },

  _computeBackgroundStyle: function(hero) {
    if (hero) {
      const url = this._computeHeroUrl(hero);
      return `background-image: url(${url})`;
    }
    return null;
  },

  _computeHeroUrl: function(hero) {
    return hero ? this.resolveUrl('../../' + hero) : '';
  },

  _onHomeClick: function() {
    this.fire('sound-trigger', 'generic_button_click');
    window.ga('send', 'event', 'overlay', 'click', 'home');
    this.fire('nav', '');
  },

  _onResumeClick: function() {
    this.fire('sound-trigger', 'generic_button_click');
    window.ga('send', 'event', 'overlay', 'click', 'resume');
    this.fire('game-resume');
  },

  _onPlayAgainClick: function() {
    this.fire('sound-trigger', 'generic_button_click');
    window.ga('send', 'event', 'overlay', 'click', 'play-again');
    this.fire('game-restart');
  },

  _onNextClick: function() {
    this.fire('sound-trigger', 'generic_button_click');
    window.ga('send', 'event', 'overlay', 'click', 'play-next');
    this.fire('random');
  },

  reset: function() {
    this.hasPause = false;
    this.score = null;
    this.shareUrl = null;
    this.hero = null;
  },

});

}());
</script>
</dom-module>
